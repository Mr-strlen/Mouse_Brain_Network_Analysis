### Third Chapter  Brain network construction

The basic process of brain network analysis includes the following four steps: defining network nodes; defining the connection relationship between nodes (defining edges); constructing a relationship matrix; performing network analysis. This chapter mainly introduces the process of network construction.

First, this chapter introduces the basic concepts of single-cell morphological reconstruction data and mesoscale data to be used, and explains the data preprocessing process and results. After that, the nodes and edges of the brain network are defined. The nodes are selected specific brain regions, and the edges are the connection relationships of different regions based on the distribution of axon length. Then, according to the definition of nodes and edges in the second chapter, a single-cell morphological connection matrix and a mesoscale connection matrix are generated respectively. Unify the data distribution of the two matrices by calculating the ratio, taking the natural logarithm and other methods, to generate the combined connection matrix. Finally, the three connection matrices obtained will be provided for the network analysis in the next section.


#### 3.1.1  Data introduction
#### 3.1.2  Preprocessing of single cell morphological reconstruction data 
Only the morphological data of neurons are saved in the swc file. In order to facilitate complex network analysis, some intermediate parameters need to be calculated on the basis of Table 3-1, specifically the following steps:

* Region matching correction
According to the previous introduction, the corresponding area in the CCFv3 framework can be obtained through the coordinates of the neuron's marker point. At the same time, it is necessary to judge whether the area is a suitable depth according to the division area given in Appendix A. If it does not comply, the matching area result needs to be modified to the area in Appendix A. The final region number is recorded as the 'region' column.

* Length calculation
Each marked point records the serial number of its parent node, and the distance between the two points can be calculated, which corresponds to the extension length of the neuron's dendrite and axon. If the value of parent node is -1, it means this is a root node and the length is 0. This column is marked as the 'length' column.

* Judgment of left or right side
Since there are left and right hemispheres in the brain, and the structure of the left and right hemispheres is symmetrical, it is necessary to judge the left and right sides of each marking point. The result is recorded as the 'side' column, 'right' represents the right hemisphere, and 'left' represents the left hemisphere
At the same time, according to whether the left or right side of each marker point and the root node (neuron soma) are the same, we can get whether they belong to the ipsilateral side or the contralatera side. Record the ipsilateral side as Ips (ipsilateral) and the contralateral side as Con (contralateral). The same and different side information will be directly judged in the complex network analysis, and has not been recorded in the file.

* Branch count
From the above introduction, the neuron morphological structure can be regarded as multiple binary trees extending from the root node, so except for the root node, the branch generated by each marker point can only be 0 (leaf node), 1 (excess node) and 2 (forked nodes). This part of information is recorded as the 'branch' column.

* Abnormal data removal
Because there is a certain error in the registration process of the CCFv3 frame mapping, it is necessary to eliminate the data that the neuron soma is not in the effective area. Excluding 6 neuron data, the data names are as follows:

*(Here is a table for deleting areas)*

#### 3.1.3 Other related processing
* Downsampling
Due to the large number of original data marked points, which greatly affects the speed of calculation and visualization, the initial data needs to be down-sampled. Downsampling needs to intercept neuron axons and dendrites at equal intervals and ensure the basic neuron morphology. Here is the specific process:
1. Set the downsampling length threshold
2. From each leaf node (value of 'branch' is 0), backtrack its parent node, and add the distance to the parent node ('length column'), which is recorded as the path length;
3. If the accumulated path length is greater than the threshold, the mark point is retained;
4. If the parent node is a multi-branch node (value of 'branch' is greater than 1), the marker point is reserved;
5. If the parent node is the root node, record the root node and the traceback ends.
The picture below is an example of downsampling result. The left picture shows the neuron shape drawn from the original data with 7362 labeled points. The right picture shows the downsampling result with 442 marked points. It can be seen that under the condition that the shape is basically maintained, the data scale is greatly reduced, which is convenient for subsequent visualization operations.

*(Here is a picture: example of downsample neuron morphology result)*

* Projection path statistics
The shape of each neuron can be seen as a sudden scattered from the neuron soma along the dendritic axis through different areas. This sequence of passing regions in turn is called projection path. Here is the specific process:
1. From each leaf node (value of 'branch' is 0), backtrack its parent node and compare whether the areas of the two marked points are the same;
2. If the area is the same, continue to backtrack;
3. If the area is different, record the area's id;
4. If the parent node is the root node, the traceback ends.
The final result is saved in json format, which will be used as supplementary information for single neuron data.
